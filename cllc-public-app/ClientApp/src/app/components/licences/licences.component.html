<div class="form-wrapper">
  <div [ngBusy]="busy"></div>
  <h1>Licences</h1>

  <div *ngIf="getNumberOfLicences() === 0">
    <h2>You do not have any licences on file</h2>  
    <p>If you currently have a liquor licence and are not seeing it here, please contact <a href="mailto:LCRBLiquor@gov.bc.ca">LCRBLiquor@gov.bc.ca</a>.</p>
  </div>  
  <section *ngFor="let mappingItem of licenceMappings | keyvalue">
    <div *ngIf="LicenceTypeSupported(mappingItem.key)">
    <h2>{{mappingItem.key}} Licences</h2>
    <form [formGroup]="mainForm">
      <table class="eq-table" >
        <tr>
          <th class="p-0">
            <img *ngIf="mappingItem.key === 'Cannabis Retail Store'" class="icon"
              src="assets/Cannabis-store-icon-blue-40px.png" alt="">
            <img *ngIf="mappingItem.key === 'Marketing'" class="icon" src="assets/Cannabis-marketing-icon-blue-40px.png"
              alt="">
            <img *ngIf="mappingItem.key === 'Catering'" class="icon" src="assets/Catering-icon-blue-40px.png" alt="">
            <img *ngIf="mappingItem.key === 'Wine Store'" class="icon" src="assets/Wine-store-icon-blue-40px.png" alt="">
          </th>
          <th style="width:250px;">Licence Details</th>
          <th style="width:250px;">Location</th>
          <th style="width:250px;">Operate</th>
          <th style="width:300px;">Request Changes</th>
          <!-- <th *ngIf="mappingItem.key === 'Catering'">Event History</th>
          <th *ngIf="mappingItem.key !== 'Catering'"></th> -->
        </tr>
        <ng-container *ngFor="let item of licenceMappings[mappingItem.key]; let i = index;">
          <tr [formGroup]="licenceForms[item.licenseId]" style="border: 1px solid #ccc; ">
            <td style="background-color: #E1E8F2; padding: 10px; width: 15px;"><span>{{i+1}}</span></td>

            <td style="padding: 10px;">
              <div>
                <strong *ngIf="item?.licenceTypeName !== 'Marketing'" style="color: #1a5a96;">
                  {{item.establishmentName}}</strong>
                  <div *ngIf="item?.licenceTypeName === 'Wine Store'"><p>{{getSubCategory(item.licenseSubCategory)}}</p></div>
              </div>
              <strong *ngIf="item?.licenceTypeName === 'Marketing'" style="color: #1a5a96;">
                Marketing Licence</strong>
              <span *ngIf="item?.licenceTypeName !== 'Marketing'">Licence Number:  <i>{{item.licenseNumber}}</i></span>
              
              <br>
              <span>Expiry / Renewal Date: {{item.expiryDate | date: 'MM/dd/yyyy'}}</span> <br>
              <div *ngIf="item.status !== PAYMENT_REQUIRED && !isAboutToExpire(item.expiryDate) "
                style="min-width: 10px; margin-bottom: 10px;">
                <a [href]="'api/licenses/' + item?.licenseId + '/pdf/' + item?.licenseNumber + '.pdf'" download>
                  <span><i class="fas fa-download" style="margin-right: 10px;"></i>Download Licence</span>
                </a>
              </div>
              <a href="javascript: void(0);" (click)="startRenewal(item)" appRemoveIfFeatureOff="CRS-Renewal"
                *ngIf="isAboutToExpire(item.expiryDate)"><i class="fas fa-exclamation-triangle"
                  style="margin-right: 10px;"></i>Renew Licence</a>
            </td>

            <td style="padding: 10px;">
              <div *ngIf="item?.licenceTypeName !== 'Marketing'">
                {{item?.establishmentAddressStreet}} <br>
                {{item?.establishmentAddressCity}} BC {{item?.establishmentAddressPostalCode}}<br>
                <input class="form-control" type="text" formControlName="phone" mask="(000) 000-0000"
                  placeholder="Store Phone Number"
                  (focusout)="updatePhone(item?.licenseId, item?.establishmentId, $event)"> <br>
                <input class="form-control" type="text" formControlName="email" placeholder="Store Email Address"
                  (focusout)="updateEmail(item?.licenseId, item?.establishmentId, $event)"> <br>
              </div>
              <div *ngIf="item?.licenceTypeName === 'Marketing'">
                {{account?.physicalAddressStreet}} <br>
                {{account?.physicalAddressCity}} {{account?.physicalAddressProvince}}
                {{account?.physicalAddressPostalCode}}<br>
                {{account?.physicalAddressCountry}} <br>
              </div>
            </td>

            <td>
              <div *ngIf="item?.licenceTypeName === ApplicationTypeNames.Catering">
                <a [routerLink]="[ '/licence/' + item.licenseId + '/event']">
                  <i class="fas fa-calendar-alt" style="margin-right: 10px;"></i>Request Event Authorization
                </a>

              </div>
              <div *ngIf="item?.licenceTypeName === ApplicationTypeNames.CannabisRetailStore">
                <mat-checkbox [checked]="item?.establishmentIsOpen"
                  (click)="toggleStoreOpen(item?.licenceTypeName, i, item?.establishmentId, !item.establishmentIsOpen);">
                  <a href="#">Show Store as Open on Map</a></mat-checkbox>
              </div>
              <div *ngIf="showPlanStoreOpening(item)"
                style="min-width: 10px; margin-bottom: 10px;">
                <a href="javascript:void(0);" (click)="planStoreOpening(item)">
                  <span *ngIf="item.status == PAYMENT_REQUIRED">
                    <i class="fas fa-shopping-cart" style="margin-right: 10px;">
                    </i>Pay Licence Fee and Plan Store Opening</span>
                  <span *ngIf="item.status != PAYMENT_REQUIRED">
                    <i class="fas fa-pencil-alt" style="margin-right: 10px;">
                    </i>Plan Store Opening</span>
                </a>
              </div>
              <div
                *ngIf="item.storeInspected && item.status == PAYMENT_REQUIRED  && item?.licenceTypeName === ApplicationTypeNames.CannabisRetailStore"
                style="min-width: 10px; margin-bottom: 10px;">
                <a href="javascript:void(0);" (click)="payLicenceFee(item)">
                  <span><i class="fas fa-shopping-cart" style="margin-right: 10px;"></i>Pay Licence Fee</span>
                </a>
              </div>
              <div
                *ngIf="item.status == PAYMENT_REQUIRED  && item?.licenceTypeName === ApplicationTypeNames.Catering"
                style="min-width: 10px; margin-bottom: 10px;">
                <a href="javascript:void(0);" (click)="payLicenceFee(item)">
                  <span><i class="fas fa-shopping-cart" style="margin-right: 10px;"></i>Pay First Year Licensing Fee</span>
                </a>
              </div>
              <div>
                <p *ngIf="item?.licenceTypeName === ApplicationTypeNames.CannabisRetailStore">
                  <a [routerLink]="[ '/federal-reporting/' + item.licenseId + '/default']">
                    <span><i class="fas fa-business-time" style="margin-right: 10px;"></i>Review Federal Reports</span>
                  </a>
                </p>
              </div>
            </td>

            <td style="background-color: #E1E8F2; padding: 10px;">
              <ng-container *ngIf="!licenceHasExpired(item.expiryDate) && (item.transferRequested !== 'Yes' && licenceTransferFeatureOn)">
                <div *ngIf="item.status != PAYMENT_REQUIRED">
                  <p>
                    <a *ngIf="licenceTransferFeatureOn" [routerLink]="[ '/ownership-transfer/' + item.licenseId]">
                      <span><i class="fas fa-exchange-alt" style="margin-right: 10px;"></i>Transfer Ownership</span>
                    </a>
                  </p>
                </div>
              </ng-container>              
              <ng-container *ngIf="!licenceHasExpired(item.expiryDate) && (item.transferRequested !== 'Yes' || !licenceTransferFeatureOn || (item?.licenceTypeName !== ApplicationTypeNames.CannabisRetailStore && item?.licenceTypeName !== ApplicationTypeNames.Marketer))">
                <div *ngIf="item.status != PAYMENT_REQUIRED">
                  <p *ngFor="let action of item.allowedActions">
                    <a href="javascript:void(0);" (click)="doAction(item,action.name)">
                      <span><i class="fas fa-bolt" style="margin-right: 10px;"></i>{{action?.actionText}}</span>
                    </a>
                  </p>
                </div>
              </ng-container>
              <section *ngIf="licenceHasExpired(item?.expiryDate)" class="licence-expired">

                Attention: This Licence has
                Expired<br>Please Renew.
              </section>

              <section *ngIf="!licenceHasExpired(item.expiryDate) && (item.transferRequested === 'Yes' && licenceTransferFeatureOn)"
                       class="licence-expired">
                TRANSFER INITIATED <br />
                <a [routerLink]="[ '/ownership-cancel-transfer/' + item.licenseId]">
                  <span><i class="fas fa-exchange-alt" style="margin-right: 10px;"></i>Cancel Transfer</span>
                </a>
              </section>

            </td>
          </tr>
          <tr *ngIf="mappingItem.key === 'Catering'">
            <td colspan="5">
              <mat-expansion-panel [expanded]="false" class="mat-elevation-z1">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        Event History <i class="fas fa-calendar-alt" style="margin-left: 10px;"></i>
                    </mat-panel-title>
                    <mat-panel-description>
                        Click to expand or collapse
                    </mat-panel-description>
                </mat-expansion-panel-header>
                <table style="width: 100%; text-align: center;">
                  <thead>
                    <th>Event Status</th>
                    <th>Client or Host Name</th>
                    <th>Date Submitted</th>
                    <th></th>
                    <th>Authorization</th>
                  </thead>
                  <tr *ngFor="let event of item?.events">
                    <td><a [routerLink]="[ '/licence/' + item.licenseId + '/event/' + event.id]">{{getOptionFromValue(eventStatus, event.status).label}}</a></td>
                    <td>{{event.clientHostname === null ? null : event.clientHostname}}</td>
                    <td>{{event.modifiedOn | date:'mediumDate'}}</td>
                    <td><a [routerLink]="[ '/licence/' + item.licenseId + '/event/' + event.id + '/security']" *ngIf="event.securityPlanRequested">Security Plan</a></td>
                    <td *ngIf="getOptionFromValue(eventStatus, event.status).label === 'Approved';else empty_td"><a [href]="'api/licenceevents/' + event.id + '/authorization.pdf'" download>
                      <span><i class="fas fa-download" style="margin-right: 10px;"></i>Download Authorization</span>
                    </a></td><ng-template #empty_td><td></td></ng-template>
                  </tr>
                </table>
              </mat-expansion-panel>
            </td>
          </tr>
        </ng-container>
      </table>
    
    </form>
    <p style="text-align: center; font-style: italic;">All {{mappingItem.key}} licence holders must follow the terms and
      conditions of their licence as set out in the <a href="{{getHandbookLink(mappingItem.key)}}"
        target="_blank">{{mappingItem.key}} Terms and Conditions Handbook</a></p>
    <p>&nbsp;</p>
    </div>
  </section>

  <section *ngFor="let mappingItem of licenceMappings | keyvalue">
    <div *ngIf="!LicenceTypeSupported(mappingItem.key)">
        <h3>{{mappingItem.key}} Licences - <i>Coming Soon</i></h3>
        <ul>
          <ng-container *ngFor="let item of licenceMappings[mappingItem.key]; let i = index;">
            <li style="font-size: 16px;">{{item.licenseNumber}} - {{item.establishmentName}}</li>
          </ng-container>

        </ul>
    </div>
  </section>
</div>
