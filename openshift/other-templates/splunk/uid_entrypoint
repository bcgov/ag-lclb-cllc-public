#!/bin/sh
echo "***** STARTING SPLUNK *****"
getent passwd | grep -q "$(id -u)"
if [ $? -eq 1 ]; then
  echo "***** Problem with whoami *****"
  if [ -w /etc/passwd ]; then
    echo "***** Updating passwd *****"
    echo "${USER_NAME:-splunkd}:x:$(id -u):0:${USER_NAME:-splunkd} user:${HOME}:/sbin/nologin" >> /etc/passwd
  fi
fi
# ensure config exists.
touch 
if [[ ! -f "/opt/splunk/etc/splunk.version" ]]; then        
  echo Updating /opt/splunk/etc
  (cd /opt/splunk-etc; tar cf - *) | (cd /opt/splunk/etc; tar xf -)        
fi

echo "***** Updating config *****"
sed -i -e '/enableSplunkdSSL =/ s/= .*/= false/' /opt/splunk/etc/system/local/server.conf

cp /opt/splunk/etc/auth/cacert.pem.default /opt/splunk/etc/auth/cacert.pem
cp /opt/splunk/etc/auth/ca.pem.default /opt/splunk/etc/auth/ca.pem

/opt/splunk/bin/splunk start
tail -n 0 -f /opt/splunk/var/log/splunk/splunkd_stderr.log
#exec /sbin/entrypoint.sh start-service