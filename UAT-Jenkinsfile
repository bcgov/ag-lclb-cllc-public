// TEST build
// uses https://github.com/openshift/jenkins-client-plugin

node('master') {
    stage('Startup') {
        if (changeset("cllc-public-app/ClientApp/*")) {
                sh 'oc cancel-build bc/cllc-public-angular'                
            }
        if (changeset("cllc-public-app/*")) {
                sh 'oc cancel-build bc/cllc-public-api'        
        }
    }

    stage('Build') {
		openshift.withCluster() {
			openshift.withProject() {
				parallel('Angular': {

					if (changeset("cllc-public-app/ClientApp/*")) {					
						def bc1 = openshift.selector('bc', 'cllc-public-angular')
						def buildSelector1 = bc1.startBuild("--commit=master")
						sleep(5)
						buildSelector1.logs('-f')
						sleep(30)
						def bc2 = openshift.selector('bc', 'cllc-public-frontend')
						def buildSelector2 = bc2.startBuild()
						
						timeout(10) { 
							buildSelector1.logs('-f')
						}
	
					}
				}, 'C# API': {
					if (changeset("cllc-public-app/*")) {
						openshift.withProject() {
					def bc = openshift.selector('bc', 'cllc-public-api')
					def buildSelector = bc.startBuild("--commit=master")
					sleep(5) 
					buildSelector.logs('-f')						   
				}
				openshift.tag("cllc-public-frontend:latest", "cllc-public-frontend:test") 
				openshift.tag("cllc-public-api:latest", "cllc-public-api:test")
					
				})
			}
		}

        
    }    
}

